<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <title>Practice English</title>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/latest/css/bootstrap.css">
</head>
<body>
  <div class="container" style="padding-top: 15px; padding-bottom: 15px;">


    <div data-bind="if: connected">
      <span class="label label-success">Connected</span>
    </div>
    <div data-bind="ifnot: connected">
      <span class="label label-danger">Disconnected</span>
    </div>



    <div data-bind="if: isJoinFormVisible">
      <h4>Join</h4>
      <form data-bind="submit: join">
        <p>
          <input type="text" placeholder="Skype" data-bind="value: skype" class="form-control" maxlength="100" required="required" />
        </p>
        <p>
          <input type="number" placeholder="Age" data-bind="value: age" class="form-control" min="3" max="110" required="required" />
        </p>
        <p>
          <input type="text" placeholder="Country" data-bind="value: country" class="form-control" maxlength="100" required="required" />
        </p>
        <p>
          <input type="text" placeholder="Topics" data-bind="value: topics" class="form-control" maxlength="200" required="required" />
        </p>
        <p>
          <input type="submit" value="Join" class="btn btn-default" />
        </p>
      </form>
    </div>

    <div data-bind="if: joined">
      <div class="clearfix">
        <h4 class="pull-left">Users</h4>
        <button data-bind="click: leave" class="pull-right btn btn-default">Leave</button>
      </div>

      <ul class="list-group" data-bind="foreach: users">
        <li class="list-group-item">
          <div class="media">
            <div class="media-left media-middle">
              <a href="#">
                <img data-bind="attr: {src: avatar, alt: Skype}" alt="Avatar" class="media-object img-circle" />
              </a>
            </div>
            <div class="media-body media-middle">
              <h3 class="media-heading">
                <span data-bind="text: Skype"></span>
                <small>
                  <span data-bind="text: Age"></span>
                  <span data-bind="text: Country"></span>
                </small>
                <small data-bind="text: Topics"></small>
              </h3>
            </div>
          </div>
        </li>
      </ul>

    </div>



  </div>
  <script src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-2.1.3.min.js"></script>
  <script src="//ajax.aspnetcdn.com/ajax/signalr/jquery.signalr-2.2.0.min.js"></script>
  <script src="//ajax.aspnetcdn.com/ajax/knockout/knockout-3.3.0.js"></script>
  <script src="//cdn.rawgit.com/jimrhoskins/knockout.localStorage/master/knockout.localStorage.js"></script>
  <script src="//practiceenglish.azurewebsites.net/signalr/hubs"></script>
  <script>
    function User(data) {
      var self = this;

      ko.utils.extend(self, data);

      self.avatar = ko.computed(function () {
        return 'http://api.skype.com/users/' + self.Skype + '/profile/avatar';
      });
    }

    function Model() {
      var self = this;

      self.connected = ko.observable(false);
      self.joined = ko.observable(false);

      self.skype = ko.observable(null, { persist: 'skype' });
      self.age = ko.observable(null, { persist: 'age' });
      self.country = ko.observable(null, { persist: 'country' });
      self.topics = ko.observable(null, { persist: 'topics' });


      self.user = ko.computed(function () {
        return {
          Skype: self.skype(),
          Age: self.age(),
          Country: self.country(),
          Topics: self.topics()

        };
      });

      self.isJoinFormVisible = ko.computed(function () {
        return self.connected() && !self.joined();
      });

      self.users = ko.observableArray();

      self.hub = jQuery.connection.chatHub;

      self.hub.client.userJoined = function (user) {
        if (self.joined() && user) self.users.push(new User(user));
      };

      self.hub.client.userLeaved = function (user) {
        if (self.joined() && user) self.users.remove(function (item) { return item.Skype === user.Skype });
      };

      self.join = function () {
        self.hub.server.join(self.user()).done(function () {
          self.joined(true);
          self.hub.server.list().done(function (users) {
            self.users(ko.utils.arrayMap(users, function (user) { return new User(user); }));
          });
        });
      };

      self.leave = function () {
        self.hub.server.leave(self.user()).done(function () {
          self.joined(false);
        });
      };

      jQuery.connection.hub.url = 'http://practiceenglish.azurewebsites.net/signalr/hubs';
      jQuery.connection.hub.start().done(function () {
        self.connected(true);
        self.joined(false);
      });

      jQuery.connection.hub.reconnecting(function () {
        self.connected(false);
        self.joined(false);
      });

      jQuery.connection.hub.reconnected(function () {
        self.connected(true);
        self.joined(false);
      });

      jQuery.connection.hub.disconnected(function () {
        self.connected(false);
        self.joined(false);
      });
    }

    var model = new Model();
    ko.applyBindings(model);
  </script>
</body>
</html>
